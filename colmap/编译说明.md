# COLMAP CUDA 编译说明

## 环境要求

- **CUDA 版本**: 12.8
- **GPU**: NVIDIA RTX 5090 (Compute Capability 12.0, Blackwell 架构)
- **Ceres Solver**:
  - **基础（仅 COLMAP CUDA / GLOMAP 可能回退 sparse CPU）**：2.2.0 + CUDA
  - **完整 GPU sparse（cuDSS / `ceres::CUDA_SPARSE`，推荐）**：2.3.0-dev + CUDA + cuDSS（安装到 `/opt/ceres-2.3.0-cuda-cudss`）
- **Eigen3**: 3.3.7
- **CMake**: 3.12 或更高版本

## 编译步骤

### 0.（可选但强烈推荐）先编译 Ceres 2.3 + cuDSS（启用 GLOMAP CUDA_SPARSE）

> 如果你希望 GLOMAP 在 GlobalPositioning/BundleAdjustment 里 **不再出现**
> `... compiled without cuDSS support. Falling back to CPU-based sparse solvers.`
> 就需要 Ceres 启用 cuDSS。

仓库内脚本：

```bash
cd /root/work/colmap
bash scripts/build_ceres_cuda_2.3.0.sh 2>&1 | tee /tmp/ceres23_build.log
```

脚本默认：
- 安装前缀：`/opt/ceres-2.3.0-cuda-cudss`
- CUDA 架构：`120`（RTX 5090 / sm_120）

### 1. 使用提供的编译脚本（推荐）

```bash
cd /root/work/colmap
./build_cuda.sh
```

### 2. 手动编译

如果需要自定义配置，可以手动执行以下步骤：

```bash
# 设置 CUDA 环境变量
export CUDA_HOME=/usr/local/cuda-12.8
export PATH=${CUDA_HOME}/bin:${PATH}
export LD_LIBRARY_PATH=${CUDA_HOME}/lib64:${LD_LIBRARY_PATH}

# 创建构建目录
mkdir -p build_cuda
cd build_cuda

# 配置 CMake
cmake .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DCUDA_ENABLED=ON \
    -DCMAKE_CUDA_COMPILER=${CUDA_HOME}/bin/nvcc \
    -DCMAKE_CUDA_ARCHITECTURES="120" \
    -DCMAKE_CUDA_STANDARD=17 \
    -DCMAKE_CXX_STANDARD=17 \
    -DGUI_ENABLED=ON \
    -DOPENGL_ENABLED=ON \
    -DSIMD_ENABLED=ON \
    -DOPENMP_ENABLED=ON \
    -DCGAL_ENABLED=ON \
    -DLSD_ENABLED=ON \
    -DDOWNLOAD_ENABLED=ON \
    -DTESTS_ENABLED=OFF

# 编译
make -j$(nproc)
```

## 关键配置说明

### CUDA 架构设置

RTX 5090 使用 Blackwell 架构，计算能力为 12.0，对应 CUDA 架构 `sm_120`。在 CMake 配置中使用：
```
-DCMAKE_CUDA_ARCHITECTURES="120"
```

### CUDA 编译器标志

脚本中已包含以下 CUDA 编译标志：
- `-Wno-deprecated-gpu-targets`: 忽略已弃用的 GPU 目标警告
- `--expt-relaxed-constexpr`: 允许在 CUDA 设备代码中使用 constexpr 函数（用于 Eigen）

### 依赖库

确保以下依赖已正确安装：
- Ceres Solver（建议使用上面脚本安装的 `/opt/ceres-2.3.0-cuda-cudss`，并在 COLMAP 配置时传 `-DCMAKE_PREFIX_PATH=/opt/ceres-2.3.0-cuda-cudss`）
- Eigen3 3.3.7
- Boost
- OpenGL/GLEW
- Qt5/Qt6（GUI 支持）
- CGAL
- 其他 COLMAP 依赖

## 常见问题

### 1. CUDA 未找到

如果 CMake 无法找到 CUDA，请确保：
- CUDA 12.8 已正确安装在 `/usr/local/cuda-12.8`
- 环境变量 `CUDA_HOME` 已设置
- `nvcc` 在 PATH 中

### 2. Ceres Solver CUDA 支持

如果 Ceres Solver 未启用 CUDA 支持，COLMAP 的 CUDA 功能可能受限。确保 Ceres 编译时启用了 CUDA。

> 额外说明：如果你已经安装了 cuDSS，但运行 GLOMAP 仍提示 “compiled without cuDSS support”，原因通常是 **Ceres 本身没启用 cuDSS**（需要使用 Ceres 2.3-dev 或更新版本重新编译）。

### 4.（少见）链接阶段报 PR_* undefined / libnspr4 ELF 损坏

如果在链接 `glomap`/`colmap` 时遇到类似：
- `undefined reference to PR_*`
- 或 `libnspr4.so: ... ELF section name out of range`

可尝试重装系统包：

```bash
sudo apt-get install -y --reinstall libnspr4 libnss3
```

### 3. 编译错误

如果遇到编译错误：
- 检查所有依赖库是否已正确安装
- 查看 CMake 配置输出中的警告信息
- 确保 CUDA 驱动版本与 CUDA 12.8 兼容

## 安装

编译完成后，可以安装到系统：

```bash
cd build_cuda
sudo make install
```

默认安装路径通常是 `/usr/local`。

## 验证

编译完成后，可以验证 CUDA 支持：

```bash
./build_cuda/src/colmap/colmap --help
```

如果编译成功，应该能看到 COLMAP 的帮助信息。

