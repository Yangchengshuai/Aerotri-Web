ä¸‹é¢æ˜¯ä¸€ä»½**å¯ç›´æ¥æ”¾è¿›ä½ ä»“åº“ **`**docs/**`** çš„æ­£å¼éƒ¨ç½²æ–‡æ¡£**ï¼Œæˆ‘ä¼šæŒ‰**å·¥ç¨‹å®è·µ + å¯é•¿æœŸç»´æŠ¤**çš„æ ‡å‡†æ¥å†™ï¼Œé»˜è®¤ä½ çš„ç¯å¢ƒæ˜¯ï¼š

+ **Ubuntu Server**
+ **åç«¯ï¼šFastAPI**
+ **å‰ç«¯ï¼šVue3 + Vite**
+ **ç›®æ ‡ï¼šå…¬ç½‘è®¿é—® + è‡ªå®šä¹‰åŸŸå + å…è´¹é•¿æœŸåœ¨çº¿**
+ **æ–¹æ¡ˆï¼šCloudflare Tunnelï¼ˆcloudflaredï¼‰**

---

# AeroTri Web å…¬ç½‘è®¿é—®éƒ¨ç½²ä¸é…ç½®æŒ‡å—
_åŸºäº Cloudflare Tunnelï¼ˆå…è´¹ / æ— éœ€å…¬ç½‘ IPï¼‰_

---

## 1. èƒŒæ™¯ä¸ç›®æ ‡
AeroTri Web é»˜è®¤ä»¥ **å±€åŸŸç½‘æœåŠ¡** æ–¹å¼è¿è¡Œï¼š

+ å‰ç«¯ï¼š`http://localhost:3000`
+ åç«¯ï¼ˆFastAPIï¼‰ï¼š`http://localhost:8000`

åœ¨ä»¥ä¸‹åœºæ™¯ä¸‹æ— æ³•ç›´æ¥è®¿é—®ï¼š

+ æœåŠ¡å™¨æ— å…¬ç½‘ IP
+ é˜²ç«å¢™ / NAT / æ ¡å›­ç½‘ / äº‘å‚å•†ç«¯å£å—é™
+ å¸Œæœ›æä¾›**ç¨³å®šã€é•¿æœŸå¯è®¿é—®çš„å…¬ç½‘ Demo**

æœ¬æŒ‡å—é€šè¿‡ **Cloudflare Tunnel** å®ç°ï¼š

âœ… å…¬ç½‘ HTTPS è®¿é—®  
âœ… è‡ªå®šä¹‰åŸŸå  
âœ… å…è´¹ã€é•¿æœŸåœ¨çº¿  
âœ… æ— éœ€å¼€æ”¾æœåŠ¡å™¨ç«¯å£

---

## 2. æ¶æ„è¯´æ˜
```plain
æµè§ˆå™¨
   â”‚
   â–¼
Cloudflare Edge (HTTPS)
   â”‚
   â–¼
cloudflaredï¼ˆæœåŠ¡å™¨æœ¬åœ°è¿›ç¨‹ï¼‰
   â”‚
   â”œâ”€â”€ http://127.0.0.1:3000  (AeroTri Frontend)
   â””â”€â”€ http://127.0.0.1:8000  (FastAPI Backend)
```

æ¨èåŸŸåç»“æ„ï¼š

| æœåŠ¡ | åŸŸå |
| --- | --- |
| å‰ç«¯ | `https://aerotri.example.com` |
| åç«¯ API | `https://api.aerotri.example.com` |


---

## 3. å‰ç½®æ¡ä»¶
### 3.1 Cloudflare è´¦å· & åŸŸå
+ ä¸€ä¸ª Cloudflare è´¦å·
+ ä¸€ä¸ªå·²æ‰˜ç®¡åˆ° Cloudflare çš„åŸŸå  
ï¼ˆDNS Nameserver å·²æŒ‡å‘ Cloudflareï¼‰

---

### 3.2 æœ¬åœ°æœåŠ¡å·²å¯è¿è¡Œ
ç¡®è®¤ä»¥ä¸‹æœåŠ¡**æœ¬åœ°æ­£å¸¸è®¿é—®**ï¼š

```bash
# åç«¯
http://127.0.0.1:8000/docs

# å‰ç«¯
http://127.0.0.1:3000
```

---

## 4. å®‰è£… cloudflaredï¼ˆå…³é”®ï¼‰
âš ï¸ **ä¸è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹é•œåƒä¸‹è½½**ï¼ˆå¦‚ ghfast.topï¼‰ï¼Œå¯èƒ½å¯¼è‡´äºŒè¿›åˆ¶æŸåï¼ˆsegfaultï¼‰

### 4.1 å®˜æ–¹ä¸‹è½½
```bash
wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
chmod +x cloudflared-linux-amd64
sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared
```

### 4.2 éªŒè¯
```bash
cloudflared --version
```

åº”è¾“å‡ºç±»ä¼¼ï¼š

```plain
cloudflared version 2025.xx.x
```

---

## 5. Cloudflare Tunnel åˆå§‹åŒ–
### 5.1 ç™»å½• Cloudflare
```bash
cloudflared tunnel login
```

æµè§ˆå™¨ä¼šè‡ªåŠ¨æ‰“å¼€ï¼Œé€‰æ‹©ä½ çš„åŸŸåå¹¶æˆæƒã€‚

---

### 5.2 åˆ›å»º Tunnel
```bash
cloudflared tunnel create aerotri-tunnel
```

ç”Ÿæˆæ–‡ä»¶ï¼š

```plain
~/.cloudflared/
â”œâ”€â”€ <tunnel-id>.json
```

---

## 6. Tunnel é…ç½®ï¼ˆæ ¸å¿ƒï¼‰
ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼š

```bash
nano ~/.cloudflared/config.yml
```

### 6.1 ç¤ºä¾‹é…ç½®
```yaml
tunnel: aerotri-tunnel
credentials-file: /root/.cloudflared/<tunnel-id>.json

ingress:
  - hostname: aerotri.example.com
    service: http://127.0.0.1:3000

  - hostname: api.aerotri.example.com
    service: http://127.0.0.1:8000

  - service: http_status:404
```

---

### 6.2 åˆ›å»º DNS è®°å½•
```bash
cloudflared tunnel route dns aerotri-tunnel aerotri.example.com
cloudflared tunnel route dns aerotri-tunnel api.aerotri.example.com
```

Cloudflare ä¼šè‡ªåŠ¨åˆ›å»º CNAME è®°å½•ã€‚

---

## 7. åç«¯ï¼ˆFastAPIï¼‰é…ç½®
### 7.1 å¯åŠ¨æ–¹å¼ï¼ˆæ¨èï¼‰
```bash
uvicorn app.main:app --host 127.0.0.1 --port 8000
```

ä¸éœ€è¦ `0.0.0.0`ï¼ŒTunnel åªè®¿é—®æœ¬æœº

---

### 7.2 CORS é…ç½®ï¼ˆå¿…é¡»ï¼‰
åç«¯å·²ç»å†…ç½®äº†æœ¬åœ°å¼€å‘åŸŸåçš„ CORS ç™½åå•ï¼ˆ`http://localhost:3000` å’Œ `http://127.0.0.1:3000`ï¼‰ï¼Œ\
å…¬ç½‘ Demo åŸŸåé€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶ï¼š

```bash
# ç¤ºä¾‹ï¼šåœ¨åç«¯ç¯å¢ƒä¸­è®¾ç½®å…è®¸çš„å‰ç«¯ Origin
export AEROTRI_FRONTEND_ORIGIN="https://aerotri.example.com"
```

åº”ç”¨å†…éƒ¨ä½¿ç”¨è¯¥ç¯å¢ƒå˜é‡è‡ªåŠ¨åŠ å…¥ CORS å…è®¸åˆ—è¡¨ï¼š

```python
from fastapi.middleware.cors import CORSMiddleware
import os

frontend_origins = [
    "http://localhost:3000",
    "http://127.0.0.1:3000",
]

demo_frontend_origin = os.getenv("AEROTRI_FRONTEND_ORIGIN")
if demo_frontend_origin:
    frontend_origins.append(demo_frontend_origin)

app.add_middleware(
    CORSMiddleware,
    allow_origins=frontend_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

---

## 8. å‰ç«¯ï¼ˆViteï¼‰é…ç½®
### 8.1 è§£å†³ allowedHosts é—®é¢˜
ç¼–è¾‘å‰ç«¯ `vite.config.mjs`ï¼š

```plain
export default defineConfig({
  server: {
    host: '127.0.0.1',
    port: 3000,
    allowedHosts: [
      // æœ¬åœ°å¼€å‘
      'localhost',
      '127.0.0.1',
      // å…¬ç½‘ Demo åŸŸå
      'aerotri.example.com',
      'api.aerotri.example.com',
      '.example.com',
    ],
  },
})
```

---

### 8.2 API åœ°å€åŒºåˆ†ç¯å¢ƒ
å‰ç«¯é€šè¿‡ Vite ç¯å¢ƒå˜é‡ `VITE_API_BASE_URL` åŒºåˆ†æœ¬åœ° / å…¬ç½‘ Demo ç¯å¢ƒï¼š

```bash
# æœ¬åœ°å¼€å‘ï¼ˆé»˜è®¤èµ° Vite ä»£ç†åˆ°æœ¬åœ° FastAPIï¼‰
# frontend/.env.local
VITE_API_BASE_URL=/api

# å…¬ç½‘ Demoï¼ˆç›´æ¥è®¿é—® Cloudflare æš´éœ²çš„ API åŸŸåï¼‰
# frontend/.env.demo
VITE_API_BASE_URL=https://api.aerotri.example.com
```

ä»£ç ä¸­ä½¿ç”¨è¯¥å˜é‡ä½œä¸º Axios çš„ baseURLï¼š

```ts
const apiBase =
  import.meta.env.VITE_API_BASE_URL && import.meta.env.VITE_API_BASE_URL.trim().length > 0
    ? import.meta.env.VITE_API_BASE_URL
    : '/api'
```

---

## 9. å¯åŠ¨é¡ºåº
```bash
# 1. å¯åŠ¨åç«¯
uvicorn app.main:app --host 127.0.0.1 --port 8000

# 2. å¯åŠ¨å‰ç«¯
pnpm run dev

# 3. å¯åŠ¨ Tunnel
cloudflared tunnel run aerotri-tunnel
```

---

## 10. éªŒè¯è®¿é—®

### 10.1 æµè§ˆå™¨éªŒè¯
- ğŸŒ å‰ç«¯ï¼š`https://aerotri.example.com`
- ğŸ”— åç«¯ API æ–‡æ¡£ï¼š`https://api.aerotri.example.com/docs`

### 10.2 å‘½ä»¤è¡ŒéªŒè¯ï¼ˆæ¨èç»™æµ‹è¯•å·¥ç¨‹å¸ˆï¼‰
```bash
# åŸºç¡€è¿é€šæ€§
curl -I https://aerotri.example.com
curl -I https://api.aerotri.example.com/docs

# å¸¦ Origin çš„ CORS éªŒè¯ï¼ˆç¤ºä¾‹ï¼‰
curl -I https://api.aerotri.example.com/health \
  -H 'Origin: https://aerotri.example.com'
```

é¢„æœŸç»“æœï¼š
- çŠ¶æ€ç ä¸º 200 / 3xxï¼Œè€Œä¸æ˜¯ 4xx / 5xxï¼›
- å“åº”å¤´ä¸­åŒ…å«æ­£ç¡®çš„ `Access-Control-Allow-Origin`ã€‚

---

## 11.ï¼ˆå¯é€‰ï¼‰è®¾ç½®ä¸ºç³»ç»ŸæœåŠ¡ï¼ˆé•¿æœŸåœ¨çº¿ï¼‰
```bash
cloudflared service install
systemctl enable cloudflared
systemctl start cloudflared
```

---

## 12. å¸¸è§é—®é¢˜
### Q1ï¼šé¡µé¢æ‰“ä¸å¼€ï¼Œæç¤º allowedHostsï¼Ÿ
âœ” æ£€æŸ¥ `vite.config.ts`

---

### Q2ï¼šAPI è·¨åŸŸå¤±è´¥ï¼Ÿ
âœ” æ£€æŸ¥ FastAPI CORS  
âœ” ç¡®è®¤å‰åç«¯åŸŸåä¸€è‡´

---

### Q3ï¼šTunnel ä¸­æ–­ï¼Ÿ
âœ” ä½¿ç”¨ `systemd`  
âœ” æˆ– `tmux / screen`

---

### Q4ï¼šæ¥å…¥ Cloudflare Access åçš„éªŒè¯æ€è·¯ï¼Ÿ
- æœªç™»å½•ç”¨æˆ·è®¿é—® `https://aerotri.example.com`ï¼š
  - é¢„æœŸï¼šå…ˆçœ‹åˆ° Access ç™»å½•é¡µï¼›ç™»å½•å¤±è´¥ / æ— æƒé™æ—¶è¢«æ‹’ç»ã€‚
- ç™»å½•åè®¿é—®å‰ç«¯å…³é”®é¡µé¢ï¼ˆå« 3D åœºæ™¯ï¼‰ï¼š
  - é¢„æœŸï¼šé¡µé¢æ­£å¸¸åŠ è½½ï¼Œæ‰€æœ‰ API / WebSocket è¯·æ±‚æ—  CORS æŠ¥é”™ã€‚
- ä½¿ç”¨ `curl` æµ‹è¯•æ— æƒé™è®¿é—®ï¼š
  - é¢„æœŸï¼šè¿”å› 4xxï¼ˆå¦‚ 403ï¼‰ï¼Œç”± Cloudflare Edge æ‹¦æˆªã€‚

---

## 13. æ¨èçš„ç”Ÿäº§å‡çº§è·¯çº¿
+ å‰ç«¯ `pnpm run build` + Nginx
+ å•åŸŸå `/api` åä»£ï¼ˆå½»åº•å… CORSï¼‰
+ Cloudflare Accessï¼ˆç§æœ‰ Demoï¼‰

---

## 14. æ€»ç»“
é€šè¿‡ Cloudflare Tunnelï¼š

+ AeroTri Web **æ— éœ€å…¬ç½‘ IP**
+ **å…è´¹ + HTTPS + è‡ªå®šä¹‰åŸŸå**
+ éå¸¸é€‚åˆ **SfM / 3D / WebGPU / Cesium** ç±»å·¥å…·æ¼”ç¤º

---

**ä¸‹ä¸€æ­¥å»ºè®®**  
ğŸ‘‰ Docker Composeï¼ˆFastAPI + Nginx + cloudflaredï¼‰  
ğŸ‘‰ å•åŸŸå `/api` æ¶æ„  
ğŸ‘‰ Cesium / 3D Tiles CDN ä¼˜åŒ–

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ç›´æ¥ç»™ä½  **ç”Ÿäº§çº§ Docker + Nginx + Tunnel çš„å®Œæ•´æ¨¡æ¿**ã€‚

