# ==============================================================================
# AeroTri Web 配置文件示例
# ==============================================================================
#
# 使用说明：
# 1. 复制本文件为 settings.yaml: cp settings.yaml.example settings.yaml
# 2. 根据你的环境修改配置项
# 3. 所有配置项都有默认值，本文件只列出常用配置
#
# 配置优先级（从高到低）：
#   1. 环境变量
#   2. settings.{environment}.yaml（如 settings.development.yaml）
#   3. settings.yaml（本文件）
#   4. defaults.yaml（默认配置，通常不需要修改）
#
# 提示：大多数配置可以通过环境变量覆盖，无需修改本文件
#       环境变量列表见 defaults.yaml 末尾

# ==============================================================================
# 应用配置
# ==============================================================================
# 调试模式（开发环境建议开启）
debug: false

# 运行环境（会影响某些默认行为）
environment: production  # development | staging | production

# CORS 允许的前端源（添加你的前端 URL）
cors_origins:
  - "http://localhost:3000"
  # - "https://your-frontend-domain.com"

# 日志级别
log_level: INFO  # DEBUG | INFO | WARNING | ERROR

# ==============================================================================
# 路径配置
# ==============================================================================
paths:
  # 数据目录（相对路径相对于项目根目录）
  data_dir: "./data"

  # 任务输出目录
  outputs_dir: "./data/outputs"

  # Block 工作目录
  blocks_dir: "./data/blocks"

  # 缩略图缓存目录
  thumbnails_dir: "./data/thumbnails"

# ==============================================================================
# 数据库配置
# ==============================================================================
database:
  # SQLite 数据库路径（可以使用绝对路径或相对路径）
  path: "./data/aerotri.db"
  # 或使用绝对路径: path: "/var/lib/aerotri/aerotri.db"

  # 连接池配置（生产环境可以调大）
  pool_size: 5
  max_overflow: 10

# ==============================================================================
# 算法可执行文件路径
# ==============================================================================
algorithms:
  # COLMAP 路径配置
  colmap:
    # 方式 1: 从 PATH 查找（推荐，适用于标准安装）
    path: "colmap"

    # 方式 2: 指定完整路径（如果不在 PATH 中）
    # path: "/usr/local/bin/colmap"
    # path: "/home/user/colmap/build/colmap"

  # GLOMAP 路径配置
  glomap:
    path: "glomap"
    # 或: path: "/usr/local/bin/glomap"

  # InstantSfM 路径配置
  instantsfm:
    path: "ins-sfm"  # 假设在 conda 环境中
    # 或: path: "/home/user/ins-conda-env/bin/ins-sfm"

  # OpenMVG 配置
  openmvg:
    # 二进制文件目录
    bin_dir: "/usr/local/bin"
    # 或: bin_dir: "/home/user/openmvg_build/Linux-x86_64-Release"

    # 相机传感器数据库
    sensor_db: "/usr/local/share/sensor_width_camera_database.txt"
    # 或: sensor_db: "/home/user/openmvg/src/openMVG/exif/sensor_width_database/sensor_width_camera_database.txt"

  # OpenMVS 配置
  openmvs:
    # 二进制文件目录
    bin_dir: "/usr/local/lib/openmvs/bin"
    # 或: bin_dir: "/home/user/openmvs_build/bin"

# ==============================================================================
# 3D Gaussian Splatting 配置
# ==============================================================================
gaussian_splatting:
  # gaussian-splatting 仓库路径（包含 train.py 的目录）
  repo_path: "/opt/gaussian-splatting"
  # 或使用相对路径: repo_path: "./gaussian-splatting"

  # Python 环境（需要包含 torch + CUDA 扩展）
  python: "python"  # 如果激活了 conda 环境，可以直接用 "python"
  # 或指定完整路径:
  # python: "/opt/gs_env/bin/python"
  # python: "/home/user/miniconda3/envs/gs_env/bin/python"

  # TensorBoard 配置
  tensorboard_path: "tensorboard"  # 或完整路径
  tensorboard_port_start: 6006
  tensorboard_port_end: 6100

  # Network GUI 配置
  network_gui_ip: "127.0.0.1"
  network_gui_port_start: 6009
  network_gui_port_end: 6109

# ==============================================================================
# SPZ 压缩配置
# ==============================================================================
spz:
  # Python 环境（需要包含 SPZ Python 绑定）
  python: "python"
  # 或: python: "/opt/spz-env/bin/python"
  # 或: python: "/home/user/miniconda3/envs/spz-env/bin/python"

# ==============================================================================
# 图像根路径配置
# ==============================================================================
image_roots:
  # 默认图像路径
  default: "./data/images"
  # 或: default: "/mnt/data/images"

  # 配置多个命名路径（可选，也可以在 config/image_roots.yaml 中配置）
  paths:
    - name: "本地数据"
      path: "./data/images"

    # - name: "外部存储"
    #   path: "/mnt/storage/images"

    # - name: "NAS 存储"
    #   path: "/mnt/nas/aerial_images"

# ==============================================================================
# 队列配置
# ==============================================================================
queue:
  # 最大并发任务数（根据 GPU 数量和内存调整）
  max_concurrent: 1  # 单 GPU 建议为 1，多 GPU 可以增加

  # 调度器轮询间隔（秒）
  scheduler_interval: 5

# ==============================================================================
# GPU 配置
# ==============================================================================
gpu:
  # GPU 状态监控间隔（秒）
  monitor_interval: 2

  # 自动 GPU 选择策略
  # - most_free: 选择显存最多的 GPU（推荐）
  # - least_used: 选择使用率最低的 GPU
  # - first_available: 选择第一个可用的 GPU
  auto_selection: "most_free"

# ==============================================================================
# 环境变量快速参考
# ==============================================================================
# 如果不想修改本文件，可以通过环境变量配置：
#
# 应用配置：
#   export AEROTRI_ENV=production
#   export AEROTRI_DEBUG=false
#
# 路径配置：
#   export AEROTRI_DB_PATH=/var/lib/aerotri/aerotri.db
#
# 算法路径（保持向后兼容）：
#   export COLMAP_PATH=/usr/local/bin/colmap
#   export GLOMAP_PATH=/usr/local/bin/glomap
#   export INSTANTSFM_PATH=ins-sfm
#   export OPENMVG_BIN_DIR=/usr/local/bin
#   export OPENMVG_SENSOR_DB=/usr/local/share/sensor_width_camera_database.txt
#   export OPENMVS_BIN_DIR=/usr/local/lib/openmvs/bin
#
# 3DGS 配置：
#   export GS_REPO_PATH=/opt/gaussian-splatting
#   export GS_PYTHON=/opt/gs_env/bin/python
#   export TENSORBOARD_PATH=/opt/gs_env/bin/tensorboard
#   export SPZ_PYTHON=/opt/spz-env/bin/python
#
# 图像路径：
#   export AEROTRI_IMAGE_ROOT=/mnt/data/images
#   export AEROTRI_IMAGE_ROOTS=/mnt/data/images:/mnt/storage
#
# 队列配置：
#   export QUEUE_MAX_CONCURRENT=2
#
# CORS 配置：
#   export AEROTRI_FRONTEND_ORIGIN=https://your-frontend-domain.com
#
# ==============================================================================
# 常见配置场景
# ==============================================================================

# 场景 1: 开发环境（使用相对路径）
# 复制本文件为 settings.development.yaml 并修改：
# debug: true
# environment: development
# paths:
#   data_dir: "./data"
# algorithms:
#   colmap:
#     path: "/usr/local/bin/colmap"
#
# 然后设置环境变量：
# export AEROTRI_ENV=development

# 场景 2: 生产环境（使用绝对路径）
# debug: false
# environment: production
# paths:
#   data_dir: "/var/lib/aerotri/data"
# database:
#   path: "/var/lib/aerotri/aerotri.db"
# image_roots:
#   default: "/mnt/data/aerial_images"

# 场景 3: Docker 部署
# 在 Docker 中，建议使用环境变量配置：
# docker run -e COLMAP_PATH=/usr/local/bin/colmap \
#            -e AEROTRI_IMAGE_ROOT=/data/images \
#            -e AEROTRI_DB_PATH=/data/aerotri.db \
#            aerotri-web:latest
#
# 或者使用 docker-compose.yml 配置环境变量

# ==============================================================================
# 故障排除
# ==============================================================================
#
# 问题：找不到可执行文件
# 解决：
#   1. 检查算法是否已安装：which colmap
#   2. 使用完整路径：path: "/usr/local/bin/colmap"
#   3. 或设置环境变量：export COLMAP_PATH=/usr/local/bin/colmap
#
# 问题：数据库路径错误
# 解决：
#   1. 使用绝对路径：path: "/var/lib/aerotri/aerotri.db"
#   2. 确保目录存在且有写权限
#   3. 设置环境变量：export AEROTRI_DB_PATH=/var/lib/aerotri/aerotri.db
#
# 问题：图像根路径无效
# 解决：
#   1. 检查路径是否存在：ls /mnt/data/images
#   2. 使用绝对路径
#   3. 确保路径有读权限
#
# 更多帮助：查看 docs/CONFIGURATION.md 和 docs/MIGRATION.md
