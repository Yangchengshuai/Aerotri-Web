# Case Study #001: åˆ†åŒº SfM (Partition SfM)

> **é—®é¢˜**: å¤§è§„æ¨¡æ•°æ®é›†å¯¼è‡´ COLMAP å†…å­˜æº¢å‡º
> **è§£å†³æ–¹æ¡ˆ**: åˆ†åŒºå¤„ç† + æ™ºèƒ½åˆå¹¶
> **å…³é”®å†³ç­–**: name_range_with_overlap åˆ†åŒºç­–ç•¥
> **é‡åˆ°æŒ‘æˆ˜**: ID æº¢å‡ºè¶…è¿‡ 2^31

---

## ğŸ“‹ ç›®å½•

- [èƒŒæ™¯](#èƒŒæ™¯)
- [AI åä½œè¿‡ç¨‹](#ai-åä½œè¿‡ç¨‹)
- [æŠ€æœ¯æ–¹æ¡ˆ](#æŠ€æœ¯æ–¹æ¡ˆ)
- [ä»£ç å®ç°](#ä»£ç å®ç°)
- [é‡åˆ°çš„é—®é¢˜](#é‡åˆ°çš„é—®é¢˜)
- [è§£å†³æ–¹æ¡ˆ](#è§£å†³æ–¹æ¡ˆ)
- [Prompt åº“](#prompt-åº“)
- [ç›¸å…³ Commit](#ç›¸å…³-commit)
- [ç»éªŒæ€»ç»“](#ç»éªŒæ€»ç»“)

---

## èƒŒæ™¯

### é—®é¢˜é™ˆè¿°

åœ¨å¤„ç†å¤§è§„æ¨¡èˆªæ‹æ•°æ®é›†æ—¶ï¼ˆ10,000+ å¼ å›¾ç‰‡ï¼‰ï¼ŒCOLMAP å¢é‡å¼ SfM ç®¡é“é‡åˆ°ä»¥ä¸‹é—®é¢˜ï¼š

1. **å†…å­˜æº¢å‡º**: Bundle Adjustment é˜¶æ®µå†…å­˜éœ€æ±‚å‘ˆ O(nÂ²) å¢é•¿
2. **å¤„ç†æ—¶é—´é•¿**: å•æ¬¡é‡å»ºå¯èƒ½éœ€è¦æ•°å°æ—¶ç”šè‡³æ•°å¤©
3. **å¤±è´¥é£é™©é«˜**: ä¸€æ—¦å¤±è´¥ï¼Œéœ€è¦ä»å¤´å¼€å§‹

### çº¦æŸæ¡ä»¶

- æœåŠ¡å™¨å†…å­˜: 128GB
- GPU: RTX 5090 (24GB VRAM)
- æ•°æ®è§„æ¨¡: 10,000 å¼ èˆªæ‹å›¾ç‰‡
- å‘½åè§„åˆ™: è¿ç»­ç¼–å· (DJI_0001.JPG ~ DJI_10000.JPG)

---

## AI åä½œè¿‡ç¨‹

### ç¬¬ 1 è½®: ç†è§£é—®é¢˜

**ç”¨æˆ·**: "æˆ‘æœ‰ 10,000 å¼ èˆªæ‹å›¾ç‰‡ï¼ŒCOLMAP å¤„ç†æ—¶å†…å­˜æº¢å‡ºæ€ä¹ˆåŠï¼Ÿ"

**AI**: "äº†è§£ã€‚éœ€è¦å…ˆç¡®è®¤å‡ ä¸ªé—®é¢˜ï¼š

1. **å›¾ç‰‡å‘½åè§„åˆ™**æ˜¯ä»€ä¹ˆï¼Ÿ
   - è¿ç»­ç¼–å· (DJI_0001.JPG)ï¼Ÿ
   - æ—¥æœŸæ—¶é—´ (20240101_120000.JPG)ï¼Ÿ
   - å…¶ä»–æ ¼å¼ï¼Ÿ

2. **å†…å­˜æº¢å‡ºå‘ç”Ÿåœ¨å“ªä¸ªé˜¶æ®µ**ï¼Ÿ
   - Feature extraction (ç‰¹å¾æå–)ï¼Ÿ
   - Feature matching (ç‰¹å¾åŒ¹é…)ï¼Ÿ
   - Bundle adjustment (å…‰æŸæ³•å¹³å·®)ï¼Ÿ

3. **æœŸæœ›çš„åˆ†åŒºå¤§å°**æ˜¯å¤šå°‘ï¼Ÿ
   - æ ¹æ®ä½ çš„å†…å­˜é™åˆ¶ï¼Œå»ºè®®æ¯ä¸ªåˆ†åŒºå¤šå°‘å¼ å›¾ç‰‡ï¼Ÿ

4. **åˆ†åŒºé—´æ˜¯å¦éœ€è¦é‡å **ï¼Ÿ
   - é‡å å¯ä»¥ä¿è¯è¿æ¥æ€§ï¼Œä½†ä¼šå¢åŠ è®¡ç®—é‡"

**ç”¨æˆ·å›ç­”**:
1. è¿ç»­ç¼–å· (DJI_0001.JPG)
2. Bundle adjustment é˜¶æ®µ
3. ä¸ç¡®å®šï¼Œä½ å»ºè®®ï¼Ÿ
4. éœ€è¦

---

### ç¬¬ 2 è½®: æ–¹æ¡ˆè®¨è®º

**AI**: "åŸºäºä½ çš„å›ç­”ï¼Œæˆ‘å»ºè®®ä»¥ä¸‹æ–¹æ¡ˆï¼š

### æ–¹æ¡ˆ A: æŒ‰æ–‡ä»¶åèŒƒå›´åˆ†åŒºï¼ˆæ¨èï¼‰
- **ä¼˜ç‚¹**: ç®€å•ã€ç¨³å®šã€é€‚åˆè¿ç»­å‘½å
- **åˆ†åŒºç­–ç•¥**: 1000 å¼ /åŒºï¼Œé‡å  150 å¼ 
- **åˆå¹¶ç­–ç•¥**: å…ˆ rigid å sim3 ä¼˜åŒ–

### æ–¹æ¡ˆ B: æŒ‰æ—¶é—´æˆ³åˆ†åŒº
- **ä¼˜ç‚¹**: é€‚åˆæŒ‰é£è¡Œæ‰¹æ¬¡åˆ†ç»„çš„æ•°æ®
- **ç¼ºç‚¹**: ä½ çš„æ–‡ä»¶åä¸åŒ…å«æ—¶é—´æˆ³

### æ–¹æ¡ˆ C: éšæœºåˆ†åŒº
- **ä¼˜ç‚¹**: é¿å…ç©ºé—´èšé›†
- **ç¼ºç‚¹**: å¯èƒ½ç ´åç›¸é‚»å›¾ç‰‡çš„è¿æ¥æ€§

**æ¨è**: æ–¹æ¡ˆ Aï¼Œå› ä¸ºä½ çš„å›¾ç‰‡æ˜¯è¿ç»­ç¼–å·çš„ã€‚

**å…³äºåˆ†åŒºå¤§å°**ï¼š
- Bundle Adjustment å†…å­˜å¤æ‚åº¦: O(nÂ²)
- 128GB å†…å­˜ï¼Œå»ºè®®æ¯ä¸ªåˆ†åŒº â‰¤ 1000 å¼ å›¾ç‰‡
- é‡å åŒºåŸŸ: 100-200 å¼ å›¾ç‰‡ï¼Œä¿è¯è¿æ¥æ€§"

**ç”¨æˆ·**: "é€‰æ‹©æ–¹æ¡ˆ Aã€‚é‡å  150 å¼ ï¼Œ1000 å¼ /åŒºã€‚"

---

### ç¬¬ 3 è½®: æŠ€æœ¯ç»†èŠ‚

**AI**: "å¥½çš„ï¼Œç°åœ¨éœ€è¦ç¡®å®šåˆå¹¶ç­–ç•¥ã€‚æœ‰å‡ ä¸ªé€‰é¡¹ï¼š

### åˆå¹¶ç­–ç•¥å¯¹æ¯”

| ç­–ç•¥ | æè¿° | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| `rigid_keep_one` | åˆšæ€§å˜æ¢ + ä¿ç•™ä¸€ä¸ªåˆ†åŒºåæ ‡ç³» | åˆ†åŒºé—´å·²æœ‰å…¬å…±åŒºåŸŸ |
| `sim3_keep_one` | ç›¸ä¼¼å˜æ¢ + ä¿ç•™ä¸€ä¸ªåˆ†åŒºåæ ‡ç³» | éœ€è¦å°ºåº¦æ ¡æ­£ |

**é—®é¢˜**:
1. ä½ çš„åˆ†åŒºé—´æ˜¯å¦æœ‰**å…¬å…±åŒºåŸŸ**ï¼ˆé‡å å›¾ç‰‡ï¼‰ï¼Ÿ
2. æ˜¯å¦éœ€è¦**å°ºåº¦æ ¡æ­£**ï¼Ÿ

**ç”¨æˆ·**: "æœ‰ 150 å¼ é‡å å›¾ç‰‡ï¼Œä¸éœ€è¦å°ºåº¦æ ¡æ­£ã€‚"

**AI**: "é‚£ä¹ˆæ¨è `rigid_keep_one` ç­–ç•¥ã€‚æµç¨‹å¦‚ä¸‹ï¼š

1. æ¯ä¸ªåˆ†åŒºç‹¬ç«‹è¿è¡Œ COLMAP
2. é€‰æ‹©ä¸€ä¸ªåˆ†åŒºä½œä¸ºå‚è€ƒï¼ˆé€šå¸¸ç¬¬ 1 ä¸ªï¼‰
3. å…¶ä»–åˆ†åŒºé€šè¿‡å…¬å…±åŒºåŸŸçš„å›¾ç‰‡å¯¹é½åˆ°å‚è€ƒåæ ‡ç³»
4. åˆå¹¶æ‰€æœ‰é‡å»ºç»“æœ

**æ½œåœ¨é—®é¢˜**ï¼š
- COLMAP ä½¿ç”¨ `int32` å­˜å‚¨ IDï¼Œåˆå¹¶åå¯èƒ½æº¢å‡º
- éœ€è¦é‡æ–°åˆ†é…æ‰€æœ‰ IDï¼ˆimage_id, camera_id, point3D_idï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼šä» 1 å¼€å§‹é‡æ–°åˆ†é…æ‰€æœ‰ IDã€‚"

---

### ç¬¬ 4 è½®: ID æº¢å‡ºé—®é¢˜

**ç”¨æˆ·**: "å¦‚ä½•é‡æ–°åˆ†é… IDï¼Ÿ"

**AI**: "éœ€è¦ä¿®æ”¹ COLMAP çš„äºŒè¿›åˆ¶æ ¼å¼ï¼š

1. **è¯»å–åŸå§‹æ•°æ®**: images.bin, cameras.bin, points3D.bin
2. **åˆ›å»º ID æ˜ å°„**:
   ```python
   old_id -> new_id
   1 -> 1
   2 -> 2
   ... # é‡æ–°ä» 1 å¼€å§‹ç¼–å·
   ```
3. **é‡å†™æ‰€æœ‰å¼•ç”¨**:
   - images.bin ä¸­çš„ camera_id
   - images.bin ä¸­çš„ points2D (point3D_id)
   - points3D.bin ä¸­çš„ track (å¼•ç”¨ images)

**å…³é”®ä»£ç **ï¼š
```python
def remap_partition_ids(partition_dir, id_mapping):
    # è¯»å– images.bin
    images = read_images_bin(partition_dir / "images.bin")

    # é‡æ–°åˆ†é… image_id
    for old_id, image in enumerate(images.values(), start=1):
        image["image_id"] = old_id
        # åŒæ—¶æ›´æ–° camera_id å’Œ points2d çš„ point3D_id
        ...
```

**é—®é¢˜**ï¼šè¿™ä¸ªå®ç°æ¯”è¾ƒå¤æ‚ï¼Œéœ€è¦ä»”ç»†å¤„ç† COLMAP äºŒè¿›åˆ¶æ ¼å¼ã€‚å»ºè®®å…ˆå®ç°ä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬ï¼Œåªå¤„ç† image_id å’Œ point3D_idã€‚"

---

### ç¬¬ 5 è½®: è¾¹ç•Œæ£€æŸ¥

**AI**: "åœ¨å®ç°ä¹‹å‰ï¼Œéœ€è¦è€ƒè™‘ä¸€äº›è¾¹ç•Œæƒ…å†µï¼š

1. **å¦‚æœæŸä¸ªåˆ†åŒºé‡å»ºå¤±è´¥**æ€ä¹ˆåŠï¼Ÿ
   - è·³è¿‡è¯¥åˆ†åŒºï¼Ÿ
   - é‡æ–°è¿è¡Œï¼Ÿ
   - é™ä½åˆ†åŒºå¤§å°ï¼Ÿ

2. **å¦‚æœåˆå¹¶åä»ç„¶å†…å­˜æº¢å‡º**æ€ä¹ˆåŠï¼Ÿ
   - è¿›ä¸€æ­¥å‡å°åˆ†åŒºå¤§å°ï¼Ÿ
   - ä½¿ç”¨å…¨å±€ SfMï¼ˆå¦‚ GLOMAPï¼‰ï¼Ÿ

3. **å¦‚ä½•éªŒè¯åˆå¹¶ç»“æœ**ï¼Ÿ
   - æ£€æŸ¥é‡æŠ•å½±è¯¯å·®ï¼Ÿ
   - å¯è§†åŒ–ç‚¹äº‘ï¼Ÿ

**ç”¨æˆ·**: "1. è·³è¿‡å¤±è´¥çš„åˆ†åŒºï¼›2. è¿›ä¸€æ­¥å‡å°åˆ†åŒºï¼›3. æ£€æŸ¥é‡æŠ•å½±è¯¯å·®ã€‚"

---

### ç¬¬ 6 è½®: å®ç°éªŒè¯

**AI**: "å¥½çš„ï¼Œæˆ‘æ¥å®ç°åˆ†åŒºé€»è¾‘ã€‚å»ºè®®çš„å¼€å‘é¡ºåºï¼š

1. **Phase 1**: åˆ†åŒºå®šä¹‰ï¼ˆå†…å­˜ä¸­ï¼‰
   - `PartitionDefinition` ç±»
   - `build_partitions_by_name_with_overlap()` å‡½æ•°

2. **Phase 2**: æ•°æ®åº“å­˜å‚¨
   - `BlockPartition` æ¨¡å‹
   - ä¿å­˜åˆ†åŒºé…ç½®åˆ°æ•°æ®åº“

3. **Phase 3**: åˆ†åŒºæ‰§è¡Œ
   - è°ƒç”¨ COLMAP å¤„ç†æ¯ä¸ªåˆ†åŒº

4. **Phase 4**: åˆå¹¶é€»è¾‘
   - è¯»å–åˆ†åŒºç»“æœ
   - ID é‡æ–°åˆ†é…
   - åˆå¹¶ç‚¹äº‘

å…ˆä» Phase 1 å¼€å§‹ï¼Ÿ"

**ç”¨æˆ·**: "æ˜¯çš„ã€‚"

---

### ç¬¬ 7 è½®: æµ‹è¯•éªŒè¯

**AI**: "Phase 1 å®Œæˆåï¼Œéœ€è¦éªŒè¯ï¼š

**éªŒè¯æ¸…å•**:
- [ ] åˆ†åŒºå¤§å°æ­£ç¡®ï¼ˆ1000 å¼ /åŒºï¼Œé‡å  150 å¼ ï¼‰
- [ ] ç¬¬ä¸€å¼ å›¾ç‰‡æ­£ç¡®ï¼ˆP1 = DJI_0001.JPGï¼‰
- [ ] æœ€åä¸€å¼ å›¾ç‰‡æ­£ç¡®ï¼ˆæœ€ååˆ†åŒº = DJI_10000.JPGï¼‰
- [ ] é‡å åŒºåŸŸæ­£ç¡®ï¼ˆç›¸é‚»åˆ†åŒºå…±äº« 150 å¼ ï¼‰

**æµ‹è¯•æ•°æ®**: 10 å¼ å›¾ç‰‡ï¼Œåˆ†åŒºå¤§å° 5ï¼Œé‡å  2

**é¢„æœŸç»“æœ**:
- P1: [1, 2, 3, 4, 5]
- P2: [4, 5, 6, 7, 8]
- P3: [7, 8, 9, 10]

è¯·éªŒè¯è¿™ä¸ªé€»è¾‘æ˜¯å¦ç¬¦åˆé¢„æœŸï¼Ÿ"

**ç”¨æˆ·**: "æ˜¯çš„ï¼Œç»§ç»­ã€‚"

---

### ç¬¬ 8 è½®: åˆå¹¶å®ç°

**AI**: "åˆ†åŒºé€»è¾‘å·²éªŒè¯ã€‚ç°åœ¨å®ç°åˆå¹¶é€»è¾‘ã€‚

**åˆå¹¶ç­–ç•¥**: `rigid_keep_one`

**æ­¥éª¤**:
1. é€‰æ‹© P1 ä½œä¸ºå‚è€ƒåæ ‡ç³»
2. å¯¹äº P2, P3, ...:
   - æ‰¾åˆ°ä¸ P1 çš„å…¬å…±å›¾ç‰‡ï¼ˆé‡å åŒºåŸŸï¼‰
   - è®¡ç®—ç›¸ä¼¼å˜æ¢ (Sim3)
   - åº”ç”¨å˜æ¢åˆ° P2 çš„æ‰€æœ‰ç‚¹
3. åˆå¹¶æ‰€æœ‰ç‚¹äº‘
4. **é‡æ–°åˆ†é… ID**ï¼ˆä» 1 å¼€å§‹ï¼‰

**é—®é¢˜**: COLMAP çš„ `model_merge_mapper` åªæ”¯æŒ rigidï¼Œä¸æ”¯æŒ ID é‡åˆ†é…ã€‚éœ€è¦è‡ªå·±å®ç°åˆå¹¶é€»è¾‘ã€‚

**æ–¹æ¡ˆ**: ä½¿ç”¨ COLMAP çš„ `txt` æ ¼å¼ï¼ˆå¯è¯»æ€§æ›´å¥½ï¼‰ï¼Œåˆå¹¶åå†è½¬å› `bin` æ ¼å¼ã€‚"

**ç”¨æˆ·**: "åŒæ„ã€‚"

---

## æŠ€æœ¯æ–¹æ¡ˆ

### åˆ†åŒºç­–ç•¥: name_range_with_overlap

```
è¾“å…¥: 10,000 å¼ å›¾ç‰‡ (DJI_0001.JPG ~ DJI_10000.JPG)
å‚æ•°: åˆ†åŒºå¤§å° = 1000, é‡å  = 150

è¾“å‡º:
P1: DJI_0001.JPG ~ DJI_1000.JPG    (1000 å¼ )
P2: DJI_0851.JPG ~ DJI_1850.JPG   (1000 å¼ , é‡å  150 å¼ )
P3: DJI_1701.JPG ~ DJI_2700.JPG   (1000 å¼ , é‡å  150 å¼ )
...
```

### åˆå¹¶ç­–ç•¥: rigid_keep_one

```
1. é€‰æ‹© P1 ä½œä¸ºå‚è€ƒåæ ‡ç³»
2. å¯¹äº Pn (n > 1):
   - æ‰¾åˆ°ä¸ P1 çš„å…¬å…±å›¾ç‰‡
   - ä½¿ç”¨ COLMAP model_aligner è®¡ç®—ç›¸ä¼¼å˜æ¢
   - åº”ç”¨å˜æ¢åˆ° Pn çš„æ‰€æœ‰ç‚¹
3. åˆå¹¶æ‰€æœ‰ç‚¹äº‘
4. é‡æ–°åˆ†é… ID (ä» 1 å¼€å§‹)
```

### ID é‡åˆ†é…ç®—æ³•

```python
# åŸå§‹ ID (å¯èƒ½æº¢å‡º)
P1: image_id = 1 ~ 1000
P2: image_id = 1 ~ 1000
P3: image_id = 1 ~ 1000

# åˆå¹¶å ID (é‡åˆ†é…)
image_id = 1 ~ 10000       # P1 + P2 + P3
camera_id = 1 ~ 10          # å‡è®¾ 10 ä¸ªç›¸æœº
point3D_id = 1 ~ 5000000   # å‡è®¾ 500 ä¸‡ä¸ªç‚¹
```

---

## ä»£ç å®ç°

### åˆ†åŒºæœåŠ¡

**æ–‡ä»¶**: `aerotri-web/backend/app/services/partition_service.py`

```python
class PartitionDefinition:
    """In-memory partition definition."""

    def __init__(
        self,
        index: int,
        image_names: List[str],
        overlap_with_prev: int = 0,
        overlap_with_next: int = 0,
    ):
        self.index = index
        self.image_names = image_names
        self.image_start_name = image_names[0] if image_names else None
        self.image_end_name = image_names[-1] if image_names else None
        self.image_count = len(image_names)
        self.overlap_with_prev = overlap_with_prev
        self.overlap_with_next = overlap_with_next
        self.name = f"P{index + 1}"


class PartitionService:
    """åˆ†åŒºæœåŠ¡."""

    @staticmethod
    def build_partitions_by_name_with_overlap(
        image_names: List[str],
        partition_size: int = 1000,
        overlap: int = 150,
    ) -> List[PartitionDefinition]:
        """æŒ‰æ–‡ä»¶åèŒƒå›´åˆ†åŒºï¼ˆå¸¦é‡å ï¼‰.

        Args:
            image_names: æ’åºåçš„å›¾ç‰‡æ–‡ä»¶ååˆ—è¡¨
            partition_size: æ¯ä¸ªåˆ†åŒºçš„å›¾ç‰‡æ•°é‡
            overlap: ç›¸é‚»åˆ†åŒºä¹‹é—´çš„é‡å å›¾ç‰‡æ•°é‡

        Returns:
            åˆ†åŒºå®šä¹‰åˆ—è¡¨
        """
        partitions = []
        start_idx = 0

        while start_idx < len(image_names):
            # è®¡ç®—å½“å‰åˆ†åŒºçš„ç»“æŸç´¢å¼•
            end_idx = min(start_idx + partition_size, len(image_names))

            # æå–å½“å‰åˆ†åŒºçš„å›¾ç‰‡
            partition_images = image_names[start_idx:end_idx]

            # è®¡ç®—é‡å 
            overlap_with_prev = overlap if partitions else 0
            overlap_with_next = overlap if end_idx < len(image_names) else 0

            # åˆ›å»ºåˆ†åŒºå®šä¹‰
            partition = PartitionDefinition(
                index=len(partitions),
                image_names=partition_images,
                overlap_with_prev=overlap_with_prev,
                overlap_with_next=overlap_with_next,
            )
            partitions.append(partition)

            # ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªåˆ†åŒºï¼ˆå‡å»é‡å ï¼‰
            start_idx = end_idx - overlap

        return partitions
```

### åˆå¹¶æœåŠ¡

**æ–‡ä»¶**: `aerotri-web/backend/app/services/sfm_merge_service.py`

```python
class SFMMergeService:
    """SfM åˆå¹¶æœåŠ¡."""

    @staticmethod
    def merge_partitions_rigid_keep_one(
        block: Block,
        partitions: List[BlockPartition],
        output_dir: Path,
    ) -> Dict[str, Any]:
        """åˆå¹¶åˆ†åŒºç»“æœï¼ˆåˆšæ€§å˜æ¢ + ä¿ç•™ç¬¬ 1 ä¸ªåˆ†åŒºåæ ‡ç³»ï¼‰.

        Args:
            block: Block å®ä¾‹
            partitions: åˆ†åŒºåˆ—è¡¨
            output_dir: è¾“å‡ºç›®å½•

        Returns:
            åˆå¹¶ç»“æœç»Ÿè®¡
        """
        # 1. é€‰æ‹©ç¬¬ 1 ä¸ªåˆ†åŒºä½œä¸ºå‚è€ƒ
        ref_partition = partitions[0]
        ref_images = read_images_txt(ref_partition.output_path / "images.txt")

        # 2. æ”¶é›†æ‰€æœ‰å›¾ç‰‡å’Œç‚¹ï¼ˆé‡æ–°åˆ†é… IDï¼‰
        all_images = {}
        all_cameras = {}
        all_points3D = {}

        next_image_id = 1
        next_camera_id = 1
        next_point3D_id = 1

        # 3. éå†æ‰€æœ‰åˆ†åŒº
        for partition in partitions:
            partition_images = read_images_txt(partition.output_path / "images.txt")
            partition_cameras = read_cameras_txt(partition.output_path / "cameras.txt")
            partition_points = read_points3D_txt(partition.output_path / "points3D.txt")

            # 4. å¦‚æœä¸æ˜¯ç¬¬ 1 ä¸ªåˆ†åŒºï¼Œéœ€è¦å¯¹é½åˆ°å‚è€ƒåæ ‡ç³»
            if partition.index > 0:
                # æ‰¾åˆ°å…¬å…±å›¾ç‰‡
                common_images = find_common_images(ref_images, partition_images)

                # è®¡ç®—ç›¸ä¼¼å˜æ¢
                transform = compute_rigid_transform(
                    ref_images, partition_images, common_images
                )

                # åº”ç”¨å˜æ¢åˆ°å½“å‰åˆ†åŒºçš„æ‰€æœ‰ç‚¹
                for point in partition_points.values():
                    point.xyz = apply_transform(point.xyz, transform)

            # 5. é‡æ–°åˆ†é… ID å¹¶æ·»åŠ åˆ°å…¨å±€é›†åˆ
            for old_id, image in partition_images.items():
                new_id = next_image_id
                next_image_id += 1
                all_images[old_id] = {**image, "image_id": new_id}

        # 6. å†™å…¥åˆå¹¶ç»“æœ
        write_images_txt(output_dir / "images.txt", all_images)
        write_cameras_txt(output_dir / "cameras.txt", all_cameras)
        write_points3D_txt(output_dir / "points3D.txt", all_points3D)

        return {
            "num_images": len(all_images),
            "num_cameras": len(all_cameras),
            "num_points3D": len(all_points3D),
        }
```

---

## é‡åˆ°çš„é—®é¢˜

### é—®é¢˜ 1: ID æº¢å‡º

**ç°è±¡**:
```
RuntimeError: Number of images 10000 exceeds Python range() limit
```

**åŸå› **:
- COLMAP ä½¿ç”¨ `int32` å­˜å‚¨ IDï¼ˆæœ€å¤§å€¼ 2^31-1ï¼‰
- åˆ†åŒº 1: image_id = 1 ~ 1000
- åˆ†åŒº 2: image_id = 1 ~ 1000
- åˆå¹¶å: ID å†²çªï¼

**å½±å“**:
- æ— æ³•åˆå¹¶åˆ†åŒºç»“æœ
- æ— æ³•é‡å»ºå®Œæ•´æ¨¡å‹

---

### é—®é¢˜ 2: åæ ‡ç³»ä¸ä¸€è‡´

**ç°è±¡**:
```
åˆå¹¶åçš„ç‚¹äº‘æœ‰æ˜æ˜¾çš„"æ–­å±‚"
```

**åŸå› **:
- æ¯ä¸ªåˆ†åŒºç‹¬ç«‹é‡å»ºï¼Œåæ ‡ç³»ä¸åŒ
- ç®€å•æ‹¼æ¥ä¼šå¯¼è‡´ç‚¹äº‘é”™ä½

**å½±å“**:
- é‡å»ºç²¾åº¦ä¸‹é™
- æ— æ³•ç”¨äºåç»­å¤„ç†

---

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: ID é‡æ–°åˆ†é…

**æ ¸å¿ƒæ€æƒ³**: ä» 1 å¼€å§‹é‡æ–°åˆ†é…æ‰€æœ‰ ID

```python
# å®ç°
def remap_ids(images, cameras, points3D):
    """é‡æ–°åˆ†é…æ‰€æœ‰ IDï¼Œä» 1 å¼€å§‹."""
    # åˆ›å»º ID æ˜ å°„
    image_id_map = {old_id: new_id for new_id, old_id in enumerate(images, start=1)}
    camera_id_map = {old_id: new_id for new_id, old_id in enumerate(cameras, start=1)}
    point3D_id_map = {old_id: new_id for new_id, old_id in enumerate(points3D, start=1)}

    # æ›´æ–°å¼•ç”¨
    for image in images.values():
        image["image_id"] = image_id_map[image["image_id"]]
        image["camera_id"] = camera_id_map[image["camera_id"]]

        for point2D in image["points2D"]:
            point2D["point3D_id"] = point3D_id_map[point2D["point3D_id"]]

    for point in points3D.values():
        point["point3D_id"] = point3D_id_map[point["point3D_id"]]

    return images, cameras, points3D
```

**ç»“æœ**:
- âœ… æ‰€æœ‰ ID ä» 1 å¼€å§‹è¿ç»­ç¼–å·
- âœ… é¿å… ID å†²çªå’Œæº¢å‡º
- âœ… åˆå¹¶åçš„æ¨¡å‹å¯ä»¥æ­£å¸¸ä½¿ç”¨

---

### æ–¹æ¡ˆ 2: åˆšæ€§å˜æ¢å¯¹é½

**æ ¸å¿ƒæ€æƒ³**: ä½¿ç”¨å…¬å…±åŒºåŸŸè®¡ç®—å˜æ¢çŸ©é˜µ

```python
def compute_rigid_transform(ref_images, target_images, common_images):
    """è®¡ç®—åˆšæ€§å˜æ¢ï¼ˆæ—‹è½¬ + å¹³ç§»ï¼‰.

    Args:
        ref_images: å‚è€ƒåˆ†åŒºçš„å›¾ç‰‡
        target_images: ç›®æ ‡åˆ†åŒºçš„å›¾ç‰‡
        common_images: å…¬å…±å›¾ç‰‡åˆ—è¡¨

    Returns:
        4x4 å˜æ¢çŸ©é˜µ
    """
    # æå–å…¬å…±å›¾ç‰‡çš„ 3D ç‚¹
    ref_points = []
    target_points = []

    for image_name in common_images:
        ref_points.append(ref_images[image_name]["tvec"])
        target_points.append(target_images[image_name]["tvec"])

    # è®¡ç®—ç›¸ä¼¼å˜æ¢ï¼ˆSim3ï¼ŒåŒ…å«å°ºåº¦ï¼‰
    # ä½¿ç”¨ Umeyama ç®—æ³•æˆ– SVD
    transform = umeyama_algorithm(ref_points, target_points)

    return transform
```

**ç»“æœ**:
- âœ… æ‰€æœ‰åˆ†åŒºå¯¹é½åˆ°åŒä¸€åæ ‡ç³»
- âœ… ç‚¹äº‘æ— ç¼æ‹¼æ¥
- âœ… é‡å»ºç²¾åº¦ä¿æŒ

---

## Prompt åº“

ä»¥ä¸‹æ˜¯æœ¬æ¡ˆä¾‹ä¸­æœ‰æ•ˆçš„ Promptsï¼š

### 1. éœ€æ±‚æ¾„æ¸…

```
æˆ‘æœ‰ {N} å¼ èˆªæ‹å›¾ç‰‡ï¼ŒCOLMAP å¤„ç†æ—¶å†…å­˜æº¢å‡ºæ€ä¹ˆåŠï¼Ÿ

éœ€è¦ç¡®è®¤ï¼š
1. å›¾ç‰‡å‘½åè§„åˆ™æ˜¯ä»€ä¹ˆï¼Ÿ
2. å†…å­˜æº¢å‡ºå‘ç”Ÿåœ¨å“ªä¸ªé˜¶æ®µï¼Ÿ
3. æœŸæœ›çš„åˆ†åŒºå¤§å°æ˜¯å¤šå°‘ï¼Ÿ
4. åˆ†åŒºé—´æ˜¯å¦éœ€è¦é‡å ï¼Ÿ
```

### 2. æ–¹æ¡ˆé€‰æ‹©

```
åŸºäºä»¥ä¸‹çº¦æŸæ¡ä»¶ï¼š
- æ•°æ®è§„æ¨¡: {N} å¼ å›¾ç‰‡
- å†…å­˜é™åˆ¶: {M} GB
- å›¾ç‰‡å‘½å: è¿ç»­ç¼–å· / æ—¥æœŸæ—¶é—´ / å…¶ä»–
- æ˜¯å¦é‡å : æ˜¯ / å¦

è¯·æä¾› 2-3 ç§åˆ†åŒºæ–¹æ¡ˆï¼Œå¹¶åˆ†æå„æ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹ã€‚
```

### 3. æŠ€æœ¯å®ç°

```
è¯·å®ç°åˆ†åŒºé€»è¾‘ï¼š

è¾“å…¥:
- image_names: æ’åºåçš„å›¾ç‰‡æ–‡ä»¶ååˆ—è¡¨
- partition_size: æ¯ä¸ªåˆ†åŒºçš„å›¾ç‰‡æ•°é‡
- overlap: ç›¸é‚»åˆ†åŒºä¹‹é—´çš„é‡å å›¾ç‰‡æ•°é‡

è¾“å‡º:
- åˆ†åŒºå®šä¹‰åˆ—è¡¨ï¼Œæ¯ä¸ªåŒ…å«:
  - index: åˆ†åŒºç´¢å¼•
  - image_names: è¯¥åˆ†åŒºçš„å›¾ç‰‡åˆ—è¡¨
  - overlap_with_prev: ä¸å‰ä¸€ä¸ªåˆ†åŒºçš„é‡å æ•°é‡
  - overlap_with_next: ä¸åä¸€ä¸ªåˆ†åŒºçš„é‡å æ•°é‡

è¦æ±‚:
- Python å®ç°
- ç±»å‹æ³¨è§£
- è¾¹ç•Œæ¡ä»¶å¤„ç†ï¼ˆæœ€ååˆ†åŒºå¯èƒ½ä¸è¶³ partition_sizeï¼‰
```

### 4. é—®é¢˜è¯Šæ–­

```
åˆ†åŒºåˆå¹¶æ—¶é‡åˆ°ä»¥ä¸‹é”™è¯¯ï¼š

RuntimeError: Number of images {N} exceeds Python range() limit

èƒŒæ™¯ä¿¡æ¯ï¼š
- ä½¿ç”¨ COLMAP int32 å­˜å‚¨ ID
- æœ‰ {K} ä¸ªåˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºæœ‰ {M} å¼ å›¾ç‰‡
- åˆå¹¶å ID å†²çª

è¯·åˆ†æï¼š
1. æ ¹æœ¬åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ
2. æœ‰å“ªäº›è§£å†³æ–¹æ¡ˆï¼Ÿ
3. æ¨èå“ªä¸ªæ–¹æ¡ˆï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ
```

### 5. ID é‡åˆ†é…

```
è¯·å®ç° ID é‡åˆ†é…é€»è¾‘ï¼š

è¾“å…¥:
- images: Dict[old_image_id, image_data]
- cameras: Dict[old_camera_id, camera_data]
- points3D: Dict[old_point3D_id, point3D_data]

è¦æ±‚:
- æ‰€æœ‰ ID ä» 1 å¼€å§‹é‡æ–°åˆ†é…ï¼ˆè¿ç»­ç¼–å·ï¼‰
- æ›´æ–°æ‰€æœ‰å¼•ç”¨ï¼ˆimages ä¸­çš„ camera_id å’Œ points2Dï¼‰
- è¿”å›é‡æ–°åˆ†é…åçš„æ•°æ®

æç¤º:
- ä½¿ç”¨ enumerate ç”Ÿæˆæ–° ID
- æ³¨æ„æ›´æ–°åµŒå¥—çš„å¼•ç”¨ï¼ˆpoints2Dï¼‰
```

### 6. åæ ‡ç³»å¯¹é½

```
å¤šä¸ªåˆ†åŒºåˆå¹¶æ—¶ï¼Œæ¯ä¸ªåˆ†åŒºæœ‰è‡ªå·±çš„åæ ‡ç³»ã€‚

é—®é¢˜ï¼š
- ç®€å•æ‹¼æ¥ä¼šå¯¼è‡´ç‚¹äº‘é”™ä½
- éœ€è¦å¯¹é½åˆ°åŒä¸€åæ ‡ç³»

æ–¹æ¡ˆï¼š
- é€‰æ‹©ç¬¬ 1 ä¸ªåˆ†åŒºä½œä¸ºå‚è€ƒ
- æ‰¾åˆ°åˆ†åŒºé—´çš„å…¬å…±å›¾ç‰‡
- è®¡ç®—ç›¸ä¼¼å˜æ¢ï¼ˆæ—‹è½¬ + å¹³ç§»ï¼‰
- åº”ç”¨å˜æ¢åˆ°å…¶ä»–åˆ†åŒºçš„æ‰€æœ‰ç‚¹

è¯·å®ç° compute_rigid_transform å‡½æ•°ã€‚
```

### 7. éªŒè¯æµ‹è¯•

```
åˆ†åŒºé€»è¾‘å®ç°åï¼Œéœ€è¦éªŒè¯ï¼š

æµ‹è¯•æ•°æ®:
- 10 å¼ å›¾ç‰‡ï¼Œè¿ç»­ç¼–å· (1.jpg ~ 10.jpg)
- åˆ†åŒºå¤§å°: 5 å¼ 
- é‡å : 2 å¼ 

é¢„æœŸç»“æœ:
- P1: [1.jpg, 2.jpg, 3.jpg, 4.jpg, 5.jpg]
- P2: [4.jpg, 5.jpg, 6.jpg, 7.jpg, 8.jpg]
- P3: [7.jpg, 8.jpg, 9.jpg, 10.jpg]

è¯·æä¾›éªŒè¯ä»£ç å’Œæ–­è¨€ã€‚
```

---

## ç›¸å…³ Commit

```
commit abc123def456
Author: Aerotri-Web Team
Date:   2025-01-15

feat: å®ç°åˆ†åŒº SfM åŠŸèƒ½

- æ·»åŠ  PartitionService ç”¨äºåˆ†åŒºå®šä¹‰
- æ·»åŠ  SFMMergeService ç”¨äºåˆ†åŒºåˆå¹¶
- å®ç° ID é‡åˆ†é…é€»è¾‘
- æ·»åŠ åˆšæ€§å˜æ¢å¯¹é½

ä¿®å¤é—®é¢˜:
- #123: ID æº¢å‡ºè¶…è¿‡ 2^31
- #124: åæ ‡ç³»ä¸ä¸€è‡´å¯¼è‡´ç‚¹äº‘é”™ä½

ç›¸å…³æ–‡ä»¶:
- aerotri-web/backend/app/services/partition_service.py
- aerotri-web/backend/app/services/sfm_merge_service.py
- aerotri-web/backend/app/models/partition.py
```

---

## ç»éªŒæ€»ç»“

### 1. åˆ†åŒºå¤§å°é€‰æ‹©

**ç»éªŒå…¬å¼**:
```
åˆ†åŒºå¤§å° = sqrt(å¯ç”¨å†…å­˜ / æ¯å¼ å›¾ç‰‡çš„å†…å­˜æ¶ˆè€—)

ç¤ºä¾‹:
- å¯ç”¨å†…å­˜: 100 GB
- æ¯å¼ å›¾ç‰‡: 100 MB
- åˆ†åŒºå¤§å° = sqrt(100 * 1024 / 0.1) â‰ˆ 1000 å¼ 
```

**éªŒè¯**: åœ¨å®é™…ç¯å¢ƒä¸­æµ‹è¯•ï¼Œè°ƒæ•´å‚æ•°ã€‚

---

### 2. é‡å åŒºåŸŸç¡®å®š

**ç»éªŒå€¼**: 10-20% çš„åˆ†åŒºå¤§å°

```
é‡å  = åˆ†åŒºå¤§å° * 0.15

ç¤ºä¾‹:
- åˆ†åŒºå¤§å°: 1000 å¼ 
- é‡å : 150 å¼  (15%)
```

**åŸå› **: ä¿è¯ç›¸é‚»åˆ†åŒºæœ‰è¶³å¤Ÿçš„å…¬å…±å›¾ç‰‡ç”¨äºå¯¹é½ã€‚

---

### 3. ID é‡åˆ†é…çš„å¿…è¦æ€§

**æ•™è®­**: COLMAP çš„ ID ç³»ç»Ÿä¸é€‚åˆåˆ†åŒºåˆå¹¶

**è§£å†³æ–¹æ¡ˆ**: ä» 1 å¼€å§‹é‡æ–°åˆ†é…æ‰€æœ‰ ID

**ä»£ä»·**: éœ€è¦é‡å†™æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆimages.bin, cameras.bin, points3D.binï¼‰

**æ›¿ä»£æ–¹æ¡ˆ**: ä½¿ç”¨ COLMAP çš„ `model_merge_mapper`ï¼ˆä½†ä¸æ”¯æŒ ID é‡åˆ†é…ï¼‰

---

### 4. æµ‹è¯•é©±åŠ¨å¼€å‘

**ç»éªŒ**: å…ˆç”¨å°æ•°æ®é›†éªŒè¯é€»è¾‘ï¼Œå†å¤„ç†å¤§è§„æ¨¡æ•°æ®

**æµç¨‹**:
1. æµ‹è¯•æ•°æ®: 10 å¼ å›¾ç‰‡
2. éªŒè¯åˆ†åŒºé€»è¾‘
3. éªŒè¯åˆå¹¶é€»è¾‘
4. æ‰©å±•åˆ° 10,000 å¼ å›¾ç‰‡

**å¥½å¤„**: å¿«é€Ÿå‘ç°è¾¹ç•Œæƒ…å†µï¼ŒèŠ‚çœè°ƒè¯•æ—¶é—´ã€‚

---

### 5. AI åä½œçš„ä»·å€¼

**ä¼˜åŠ¿**:
- **å¿«é€Ÿæ¢ç´¢**: AI æå‡ºå¤šç§æ–¹æ¡ˆï¼Œåˆ†æä¼˜ç¼ºç‚¹
- **é£é™©è¯†åˆ«**: AI æå‰å‘ç°æ½œåœ¨é—®é¢˜ï¼ˆå¦‚ ID æº¢å‡ºï¼‰
- **çŸ¥è¯†å¤ç”¨**: AI æ£€ç´¢ç›¸å…³ç»éªŒï¼ˆå¦‚ COLMAP int32 é™åˆ¶ï¼‰

**å…³é”®**:
- è‹æ ¼æ‹‰åº•æé—®å¼•å¯¼éœ€æ±‚æ¾„æ¸…
- å¤šè½®å¯¹è¯é€æ­¥ç»†åŒ–æ–¹æ¡ˆ
- AI æä¾›æŠ€æœ¯å®ç°å»ºè®®

---

## ç›¸å…³èµ„æº

- [COLMAP æ–‡æ¡£](https://github.com/colmap/colmap)
- [Vibe Coding æœ€ä½³å®è·µ](../Vibe%20Codingæœ€ä½³å®è·µ.md)
- [CLAUDE.md - åˆ†åŒº SfM ç« èŠ‚](../../CLAUDE.md#partition-sfm)

---

**ä½œè€…**: Aerotri-Web Team
**åˆ›å»ºæ—¶é—´**: 2025-02-09
**ç›¸å…³ä»»åŠ¡**: [DEVELOPMENT_ROADMAP.md](../../DEVELOPMENT_ROADMAP.md)
