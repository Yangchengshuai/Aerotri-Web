# 项目说明文档（colmap_glomap + AeroTri Web）

## 1. 背景与目标

本项目的目标是提供一套 **面向空中三角测量（Aerotriangulation / SfM）** 的工程化工具链：

- **算法侧**：基于 COLMAP（增量式）与 GLOMAP（全局式）完成特征提取、匹配、建图/平差。
- **产品侧**：提供一个 Web 应用，支持：
  - 新建/管理多个 block（项目/批次）
  - 导入图像并预览/删除（删除只作用于工作区，保护原始数据）
  - 选择算法与关键参数，指定 GPU 并运行
  - 监控阶段、进度、日志
  - 任务完成后浏览相机位姿、稀疏点云、统计信息
  - 多个 block 的结果对比（速度/质量）

## 2. 交付物

- `colmap/`：COLMAP 源码（含你们在本地环境的编译脚本/文档）
- `aerotri-web/`：AeroTri Web 前后端代码
- `docs/`：本仓库说明/使用/开发文档

## 3. 系统架构

### 3.1 高层架构图（ASCII）

```
+-------------------+         HTTP/WS          +-------------------------+
|   Browser (UI)    | <----------------------> |  AeroTri Web Backend     |
|  Vue3 + Element+  |                          |  FastAPI + SQLite        |
+-------------------+                          +-----------+-------------+
        |                                                     |
        | WebGL/Three.js                                     | subprocess
        | (render cameras/points)                            v
        |                                          +---------------------+
        |                                          |  COLMAP / GLOMAP     |
        |                                          |  (GPU accelerated)   |
        |                                          +----------+----------+
        |                                                     |
        v                                                     v
+-------------------+                          +-------------------------+
|  Local UI State    |                          |  FS: working dir / out  |
|  Pinia Store       |                          |  DB: blocks metadata     |
+-------------------+                          +-------------------------+
```

### 3.2 核心数据对象：Block

Block 表示一次空三“工程/批次”。它关联：

- 输入图像目录（source）与安全工作区目录（working）
- 算法类型：COLMAP 或 GLOMAP
- 参数：feature/matching/mapper
- 运行状态：created/running/completed/failed/cancelled
- 输出目录：数据库、稀疏模型、日志等

状态机（简化）：

```
created
  | run
  v
running  ----stop----> cancelled
  |
  | success
  v
completed
  |
  | rerun（允许从 completed/failed/cancelled 再次 run）
  v
running

running --error--> failed
```

## 4. 功能模块拆解

### 4.1 前端（Vue3）

- **HomeView（Block 列表 + 新建）**
  - 新建 block：名称、图像目录、算法、匹配方法
- **BlockDetailView（Block 详情页）**
  - 左栏：图像预览、参数摘要/配置、GPU 选择
  - 中栏 Tabs：
    - 运行进度：阶段、耗时、日志
    - 3D 查看：相机位姿 + 点云
    - 统计数据：注册图像数/3D 点数/重投影误差/各阶段耗时等
- **CompareView（对比页）**
  - 选择两个 completed 的 block，对比：注册图像数、3D 点数、重投影误差、总耗时

### 4.2 后端（FastAPI）

- **Block API**：创建、查询、更新、删除
- **Image API**：列表、缩略图、原图获取、删除（安全删除）
- **GPU API**：读取 GPU 使用率/显存/可用性
- **Task API**：提交任务、查询状态、停止任务
- **WS**：推送实时进度
- **TaskRunner**：异步运行子进程（COLMAP/GLOMAP），解析日志并更新 DB
- **ResultReader**：读取 `images.bin/points3D.bin` 等二进制结果用于前端渲染/统计

## 5. 关键交互流程

### 5.1 新建与导入

1) 用户在首页点击“新建 Block”，填写：名称 + 图像目录 + 算法/匹配方法
2) 后端创建 block 时：
   - 生成 block_id
   - 创建安全工作目录（working dir），对源目录中的图像做硬链接/软链接
   - 之后所有预览/删除都基于 working dir，**不影响源数据**

### 5.2 运行空三

1) 用户选择 GPU index 点击“运行空三”
2) 后端启动 TaskRunner：

```
feature_extraction -> matching -> mapping(COLMAP/GLOMAP) -> completed
```

3) 进度来源：解析子进程 stdout/stderr 日志
4) WebSocket 推送：detail stage + detail progress + message

### 5.3 结果浏览

- 3D 查看：拉取相机位姿与 points3D，Three.js 渲染
- 统计数据：拉取 `/result/stats`
- 对比：从 block.statistics + `/result/stats` 组合展示

## 6. 已处理的关键问题（P0/P1）

- **TaskRunner 单例化**：避免 API 与 WS 分别实例化导致进度不一致
- **后台任务 DB Session 生命周期**：后台任务自建 Session，避免 request-session 被关闭
- **日志持久化**：输出 `run.log`，任务完成后仍可回放
- **安全删除图像**：只允许删除 working dir 内文件，防止误删原始数据
- **时区问题**：前端解析后端 naive UTC 时间，修复 +8 小时误差
- **统计信息补齐**：`/result/stats` 合并二进制统计与 block.statistics

