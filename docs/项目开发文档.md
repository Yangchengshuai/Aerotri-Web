# 项目开发文档（架构/模块/接口/数据/测试）

## 1. 代码结构

```
work/
├── colmap/
│   ├── src/ ...                    # COLMAP 源码
│   ├── doc/ ...                    # 文档（含编译与参数说明）
│   └── scripts/ ...                # 构建脚本
├── aerotri-web/
│   ├── backend/
│   │   ├── app/
│   │   │   ├── api/                # REST API
│   │   │   ├── ws/                 # WebSocket
│   │   │   ├── models/             # SQLAlchemy ORM
│   │   │   ├── services/           # 任务、GPU、workspace、结果读取
│   │   │   └── main.py
│   │   └── tests/
│   └── frontend/
│       ├── src/
│       │   ├── views/              # Home/BlockDetail/Compare
│       │   ├── components/         # 进度、3D、统计、参数表单等
│       │   ├── api/                # axios 封装
│       │   ├── stores/             # Pinia
│       │   └── composables/        # WebSocket hook
│       └── package.json
└── docs/
```

## 2. 后端设计

### 2.1 REST API（核心）

- Block
  - `GET /api/blocks`
  - `POST /api/blocks`
  - `GET /api/blocks/{id}`
  - `PATCH /api/blocks/{id}`
  - `DELETE /api/blocks/{id}`

- Task
  - `POST /api/blocks/{id}/run`
  - `GET /api/blocks/{id}/status`
  - `POST /api/blocks/{id}/stop`

- Result
  - `GET /api/blocks/{id}/result/cameras`
  - `GET /api/blocks/{id}/result/points?limit=`
  - `GET /api/blocks/{id}/result/stats`

- WebSocket
  - `WS /ws/blocks/{id}/progress`

### 2.2 TaskRunner 任务执行

流水线：

```
feature_extraction  ->  matching  ->  mapping  ->  completed
   (COLMAP)             (COLMAP)     (COLMAP/GLOMAP)
```

- 子进程启动：`asyncio.create_subprocess_exec`
- 日志解析：`LogParser.parse_line(line)`
- 进度更新：
  - detail progress（0-100）来自日志
  - overall progress 将三段映射到 0-100

```
feature_extraction: 0%  -> 33%
matching:          33% -> 66%
mapping:           66% -> 100%
```

- DB 更新节流：每 0.5s 或 detail 变化/进度变化显著时写库
- 日志持久化：`outputs/<block_id>/run.log`

### 2.3 数据安全：working dir

设计目标：**任何 UI 删除/修改都不影响源目录**。

```
source dir (只读)
   |
   | hardlink/symlink
   v
working dir (可预览/可删除)
```

- `WorkspaceService.populate_working_dir()` 负责准备工作区
- `safe_resolve_child()` 防止路径穿越

### 2.4 结果读取

- `ResultReader.read_cameras()`：解析 `images.bin`（姿态/位移/文件名）
- `ResultReader.read_points3d()`：解析 `points3D.bin`（xyz + rgb + track length）
- `ResultReader.get_stats()`：统计点数、观测数、误差、轨迹长度
- `/result/stats`：合并二进制统计 + `block.statistics`（阶段耗时、算法参数）

## 3. 前端设计

### 3.1 页面与组件

- `HomeView.vue`：Block 列表、新建对话框
- `BlockDetailView.vue`：详情页（左侧控制 + 中间 Tabs）
- `CompareView.vue`：两个 block 指标对比

关键组件：

- `ImagePreview.vue`：缩略图/分页/删除
- `ParameterForm.vue`：参数配置
- `GPUSelector.vue`：GPU 列表与选择
- `ProgressView.vue`：进度/阶段/时间/日志
- `ThreeViewer.vue`：Three.js 渲染
- `StatisticsView.vue`：统计指标与阶段耗时图

### 3.2 WebSocket 进度

- `useWebSocket(blockId)` 建立 WS 连接
- 后端推送：`{ stage, progress, message }`
- 前端展示：
  - Step：粗阶段
  - 进度条：overall 或 detail
  - 日志：通过 `/status` 轮询或 WS status 请求

### 3.3 时间与时区

后端存储 naive UTC，前端解析时若无时区后缀追加 `Z`，避免本地时区误差。

## 4. 本地开发与测试

### 4.1 后端

```bash
cd aerotri-web/backend
python3 -m pip install -r requirements.txt
python3 -m pytest
```

### 4.2 前端

```bash
cd aerotri-web/frontend
npm install
npm run test
```

## 5. 部署建议（单机/内网）

- 后端：`uvicorn` 或 `gunicorn + uvicorn workers`
- 前端：`npm run build` 后用 Nginx 静态托管，反向代理 `/api` 与 `/ws`

## 6. 进一步改进方向

- 3D Viewer：
  - 点大小/相机图标大小随场景自适应（基于 bbox 或点密度）
  - 增加点云抽样/分层加载提升性能
  - 增加坐标系/单位标注与重置视角
- 任务系统：
  - 队列化、多任务并发控制、GPU 占用策略
  - 任务失败可重试/断点续跑
- 结果统计：
  - 更细的质量指标（比如注册率、轨迹长度分布、重投影误差分布）
  - block 对比更多维度

