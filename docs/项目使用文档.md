# 项目使用文档（AeroTri Web）

## 1. 运行环境

- **后端**：Python 3（建议 3.10+），FastAPI
- **前端**：Node.js 18+（建议）
- **GPU（可选）**：NVIDIA 驱动 + CUDA；用于 COLMAP/GLOMAP 加速

> COLMAP/GLOMAP 可执行文件路径由环境变量 `COLMAP_PATH` / `GLOMAP_PATH` 指定。

## 2. 启动服务

### 2.1 后端

```bash
cd aerotri-web/backend
python3 -m pip install -r requirements.txt
python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000
```

- Swagger：`http://<server-ip>:8000/docs`
- Health：`http://<server-ip>:8000/health`

### 2.2 前端

```bash
cd aerotri-web/frontend
npm install
npm run dev -- --host 0.0.0.0 --port 5173
```

访问：`http://<server-ip>:5173`

## 3. 推荐使用流程

### 3.1 新建 Block

1) 首页点击“新建 Block”
2) 填：
   - 名称
   - 图像目录（服务器本地路径）
   - 算法：GLOMAP 或 COLMAP
   - 匹配方法：sequential / exhaustive / vocab_tree

创建后自动进入 Block 详情页。

### 3.2 图像预览与删除（安全）

- 图像预览基于后端生成缩略图。
- 删除操作只对 block 的工作目录生效：

```
source_image_path (只读/不删除)
working_image_path (允许删除)
```

### 3.3 配置参数

在 Block 详情页左侧“算法参数”中点击“配置”。常用参数：

- 特征提取：
  - `max_image_size`
  - `max_num_features`
  - `camera_model`
- 匹配：
  - `method`（与匹配方法保持一致）
  - `overlap`（sequential）
- Mapper：
  - COLMAP：`Mapper.ba_use_gpu`
  - GLOMAP：`GlobalPositioning.use_gpu` / `BundleAdjustment.use_gpu` 等

### 3.4 选择 GPU 与运行

1) 左侧选择 GPU index
2) 点击“运行空三”
3) 运行中可点击“停止”

### 3.5 监控进度

- “运行进度” Tab：
  - 阶段 Steps
  - 进度条
  - 开始时间/耗时
  - 运行日志（实时 + 完成后可回放）

### 3.6 查看结果

- “3D 查看” Tab：相机位姿（frustum）+ 稀疏点云（points3D）
- “统计数据” Tab：注册图像数、3D 点数、观测数、重投影误差、各阶段耗时

### 3.7 对比结果

进入对比页面（CompareView），选择两个 completed 的 block：

- 注册图像数
- 3D 点数
- 平均重投影误差
- 总耗时

## 4. 常见问题排查

### 4.1 后端报 COLMAP/GLOMAP 找不到

检查环境变量：

```bash
echo $COLMAP_PATH
echo $GLOMAP_PATH
```

并确保对应可执行文件存在且有执行权限。

### 4.2 进度条不动 / 日志为空

- 查看后端控制台/日志
- 查看输出目录是否生成：

```
aerotri-web/data/outputs/<block_id>/run.log
```

### 4.3 GPU 显示不可用

- 确认 `nvidia-smi` 正常
- 确认 pynvml 安装正确

### 4.4 图像删除为什么不影响原始目录

这是设计目标：保证源数据安全。删除只作用于 working dir。

